
<!-- This layout has been taken from http://globus.org/provision/ -->


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>futuregrid.virtual.cluster.FGCluster &mdash; Cloud Metrics 2.1.3 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '2.1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Cloud Metrics 2.1.3 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11111']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  </head>
  <body>

<div style="background-image:url('_static/header_bg.png');background-color: black; text-align: left; padding: 10px 10px 15px 35px">
<a href="../../../../index.html"><img src="../../../../_static/logo_rain.png" border="0" alt="FutureGrid Rain"/></a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Rain Home</a>|&nbsp;</li>
        <li><a href="../../../../whatis.html">What is FutureGrid Rain?</a>|&nbsp;</li>
        <li><a href="../../../../quickstart.html">Rain Quickstart</a>|&nbsp;</li>
        <li><a href="../../../../documentation.html">Rain Documentation </a>|&nbsp;</li>
        <li><a href="../../../../download.html">Download</a>|&nbsp;</li>
        <li><a href="../../../../support.html">Support</a>|&nbsp;</li>
        <li><a href="https://portal.futuregrid.org/">FutureGrid Home</a>|&nbsp;</li>

          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>

      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
<body style="background-image:url('_static/header_bg.png');background-color: grey;">
</body>

      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for futuregrid.virtual.cluster.FGCluster</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">FGCluster command</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">FGCluster.py (python)</span>
<span class="sd">-------------------------</span>

<span class="sd">Operations for managing virtual clusters</span>

<span class="sd">Name fg-cluster</span>

<span class="sd">Description</span>

<span class="sd">usage:</span>

<span class="sd">    fg-cluster &lt;parameters&gt;</span>

<span class="sd">    -f -- futuregrid configuration file</span>
<span class="sd">          which specifies the location of</span>
<span class="sd">          necessary files to run program</span>

<span class="sd">    --debug -- show debug message</span>

<span class="sd">    --default-repository -- set if to use IU ubuntu repo</span>
<span class="sd">                            if specifyed, then not use IU</span>
<span class="sd">                            ubuntu repo</span>

<span class="sd">    --create-key -- create euca key file</span>

<span class="sd">    subcommands:</span>

<span class="sd">    run: run a virtual cluster of given parameters</span>

<span class="sd">    -a -- virtual cluster name</span>
<span class="sd">    -n -- compute node number</span>
<span class="sd">    -i -- image type</span>
<span class="sd">    -t -- instance type</span>

<span class="sd">    checkpoint: save the state of currently running cluster</span>

<span class="sd">    -a -- virtual cluster name</span>
<span class="sd">    -c -- control node bucket name</span>
<span class="sd">    -t -- control node image name</span>
<span class="sd">    -m -- compute node bucket name</span>
<span class="sd">    -e -- compute node image name</span>

<span class="sd">    restore: restore state of saved virtual cluster</span>

<span class="sd">    -a -- virtual cluster name</span>

<span class="sd">    terminate: terminate a virtual cluster of given name</span>

<span class="sd">    -a -- virtual cluster name</span>

<span class="sd">    status: show status of virtual cluster(s)</span>

<span class="sd">    -a -- virtual cluster name</span>

<span class="sd">    If no virtual cluster name is specified, the command will return</span>
<span class="sd">    status of all virtual clusters recorded</span>

<span class="sd">    list: list virtual clusters</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">boto.ec2</span>

<span class="kn">from</span> <span class="nn">boto.ec2.connection</span> <span class="kn">import</span> <span class="n">EC2Connection</span>
<span class="kn">from</span> <span class="nn">futuregrid.virtual.cluster.CloudInstances</span> <span class="kn">import</span> <span class="n">CloudInstances</span>
<span class="c">#from CloudInstances import CloudInstances</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">NoOptionError</span>
<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">MissingSectionHeaderError</span>
<span class="kn">from</span> <span class="nn">ConfigParser</span> <span class="kn">import</span> <span class="n">NoSectionError</span>


<div class="viewcode-block" id="Cluster"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster">[docs]</a><span class="k">class</span> <span class="nc">Cluster</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class Cluster</span>
<span class="sd">    -------------</span>
<span class="sd">    Methods to</span>
<span class="sd">        run virtual cluster</span>
<span class="sd">        checkpoint virtual cluster</span>
<span class="sd">        restore virtual cluster</span>
<span class="sd">        terminate virtual cluster</span>
<span class="sd">        show status of virtual cluster(s)</span>
<span class="sd">        list virtual clusters</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">userkey</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">cloud_instances</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">backup_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">enrc</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">slurm</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">cloud</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ec2_conn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user_login</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># debug switch</span>
    <span class="n">if_debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># if false, using IU ubuntu repository</span>
    <span class="n">if_default</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># if true, create userkey key</span>
    <span class="n">if_create_key</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># repo file name</span>
    <span class="n">sources_list</span> <span class="o">=</span> <span class="s">&#39;sources.list&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        init method</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Cluster</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span> <span class="o">=</span> <span class="n">CloudInstances</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO PRINT HELP MESSAGES</span>
<span class="c"># ---------------------------------------------------------------------</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Cluster.msg"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.msg">[docs]</a>    <span class="k">def</span> <span class="nf">msg</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for printing help messages</span>

<span class="sd">        Parameters:</span>
<span class="sd">            message -- message to print</span>

<span class="sd">        Logic:</span>
<span class="sd">            use print to print message</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">print</span> <span class="n">message</span>
</div>
<div class="viewcode-block" id="Cluster.print_section"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.print_section">[docs]</a>    <span class="k">def</span> <span class="nf">print_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Prints section header</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">=========================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;=========================&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.debug"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.debug">[docs]</a>    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for printing debug message</span>

<span class="sd">        Parameter:</span>
<span class="sd">            message -- message to print</span>

<span class="sd">        Logic:</span>
<span class="sd">            Checks debug flag, if debug flag is set to</span>
<span class="sd">            true, then prints debug message, if is set</span>
<span class="sd">            to false, then does not print debug message</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_debug</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">message</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO SET PROGRAM FLAGS</span>
<span class="c"># ---------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="Cluster.set_interface"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.set_interface">[docs]</a>    <span class="k">def</span> <span class="nf">set_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set interface the program to use</span>

<span class="sd">        Parameter:</span>
<span class="sd">            interface -- interface (boto or euca2ools)</span>

<span class="sd">        command line argument --interface will</span>
<span class="sd">        overwrite the configure in configuration file</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">interface</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;euca2ools&#39;</span><span class="p">,</span> <span class="s">&#39;boto&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Interface should be boto or euca2ools&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec2_connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.set_cloud"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.set_cloud">[docs]</a>    <span class="k">def</span> <span class="nf">set_cloud</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cloud</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set cloud</span>

<span class="sd">        Parameter:</span>
<span class="sd">            cloud -- cloud (nova or eucalyptus)</span>

<span class="sd">        command line argument --cloud will</span>
<span class="sd">        overwrite the configure in configuration file</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">cloud</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">cloud</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;nova&#39;</span><span class="p">,</span> <span class="s">&#39;eucalyptus&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Cloud should be boto or euca2ools&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;nova&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span> <span class="o">=</span> <span class="s">&#39;ubuntu&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;eucalyptus&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span> <span class="o">=</span> <span class="s">&#39;root&#39;</span>
</div>
<div class="viewcode-block" id="Cluster.set_flag"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.set_flag">[docs]</a>    <span class="k">def</span> <span class="nf">set_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sets control flags</span>

<span class="sd">        Parameter:</span>
<span class="sd">            args -- this method deals args.if_debug, if_default</span>
<span class="sd">                    if_create_key.</span>

<span class="sd">                    if_debug: default is false</span>
<span class="sd">                              true to print debug message</span>
<span class="sd">                              false not to print</span>

<span class="sd">                    if_default: default is false</span>
<span class="sd">                                true to use default ubuntu repository</span>
<span class="sd">                                false to use IU ubuntu repository</span>

<span class="sd">                    if_create_key: default is false</span>
<span class="sd">                                   true to create key for users</span>
<span class="sd">                                   false not to create</span>
<span class="sd">                    if_boto: default is false</span>
<span class="sd">                             true to use boto interface</span>
<span class="sd">                             false to use euca2ools</span>

<span class="sd">        Logic:</span>
<span class="sd">            Sets control flags</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">if_debug</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_default</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">default_repository</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_create_key</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">create_key</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS ABOUT KEYPAIRS</span>
<span class="c"># ---------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="Cluster.if_keypair_exits"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.if_keypair_exits">[docs]</a>    <span class="k">def</span> <span class="nf">if_keypair_exits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if key is already created</span>

<span class="sd">        Parameters:</span>
<span class="sd">            name -- key name</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-describe-keypairs to check the keys created,</span>
<span class="sd">            finds name in the command result</span>

<span class="sd">        Return:</span>
<span class="sd">            true -- if finds the key given name as parameter</span>
<span class="sd">            false -- if does not fine the key given name as parameter</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;euca-describe-keypairs&#39;</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Cluster.add_keypair"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.add_keypair">[docs]</a>    <span class="k">def</span> <span class="nf">add_keypair</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adds keypair</span>

<span class="sd">        Parameter:</span>
<span class="sd">            name -- userkey name</span>
<span class="sd">            key -- location of userkey</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-add-keypair to create key for user, key will</span>
<span class="sd">            be created under the location referred by key</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;euca-add-keypair </span><span class="si">%s</span><span class="s"> &gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="mo">0600</span><span class="p">)</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHOD TO PARSE CONFIGURATION FILE</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.parse_conf"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.parse_conf">[docs]</a>    <span class="k">def</span> <span class="nf">parse_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s">&#39;unspecified&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse configuration file</span>

<span class="sd">        Parameters:</span>
<span class="sd">            file_name -- configuration file name</span>
<span class="sd">            default: unspecified</span>

<span class="sd">        Logic:</span>
<span class="sd">            Parse configuration file if given, default location</span>
<span class="sd">            &#39;~/.futuregrid/futuregrid.cfg&#39;. If no file is given,</span>
<span class="sd">            finds configuration file by following order:</span>
<span class="sd">                1) finds current directory &#39;futuregrid.cfg&#39;</span>
<span class="sd">                2) finds in default location</span>

<span class="sd">            configuration file format:</span>
<span class="sd">            [virtual-cluster]</span>
<span class="sd">            # Backup file for saving and loading virtual cluster(s)</span>
<span class="sd">            backup = ~/.futuregrid/virtual-cluster</span>
<span class="sd">            # Slurm configuration input file</span>
<span class="sd">            slurm = ~/.futuregrid/slurm.conf.in</span>
<span class="sd">            # userkey pem file</span>
<span class="sd">            userkey = ~/PUT-YOUR-USER-NAME.pem</span>
<span class="sd">            # environment file</span>
<span class="sd">            enrc = ~/novarc</span>

<span class="sd">            Checks if all files specified in configuration</span>
<span class="sd">            file are present.If create-key is set to true,</span>
<span class="sd">            first check if key exists, if key does not exist,</span>
<span class="sd">            then creates key under the location where is specified</span>
<span class="sd">            by userkey in the configuration file</span>

<span class="sd">            Due to different version of this tool, back-end</span>
<span class="sd">            structure of backup file may change, so checks</span>
<span class="sd">            if backup file has the correct format before the start</span>

<span class="sd">            Checks all possible errors about configuration file</span>

<span class="sd">        No returns</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># default location ~/.futuregrid/futuregrid.cfg</span>
            <span class="c"># read[], reads begin from last to first</span>
            <span class="c"># so, first reads file_name, then current directory, then default</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&#39;~/.futuregrid/futuregrid.cfg&#39;</span><span class="p">),</span>
                         <span class="s">&#39;futuregrid.cfg&#39;</span><span class="p">,</span>
                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">file_name</span><span class="p">)])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">backup_file</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual-cluster&#39;</span><span class="p">,</span> <span class="s">&#39;backup&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Backup file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">userkey</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual-cluster&#39;</span><span class="p">,</span> <span class="s">&#39;userkey&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Userkey </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enrc</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual-cluster&#39;</span><span class="p">,</span> <span class="s">&#39;enrc&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;enrc </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slurm</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual-cluster&#39;</span><span class="p">,</span> <span class="s">&#39;slurm&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SLURM configuration input file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual-cluster&#39;</span><span class="p">,</span> <span class="s">&#39;interface&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;virtual-cluster&#39;</span><span class="p">,</span> <span class="s">&#39;cloud&#39;</span><span class="p">)</span>

            <span class="c"># checking if all file are present</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if all file are present&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_create_key</span><span class="p">:</span>
                    <span class="c"># create key for user</span>
<span class="c">#                    self.add_keypair(self.user)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_keypair_exits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">You have userkey </span><span class="si">%s</span><span class="s">.pem, please correct&#39;</span>
                                 <span class="s">&#39; its location in configuration file&#39;</span>
                                 <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_keypair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: You must have userkey file&#39;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enrc</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: You must have novarc file&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Reading environment&#39;</span><span class="p">)</span>
                <span class="n">key_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enrc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">key_dir</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;nova&#39;</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;NOVA_KEY_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_dir</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span><span class="s">&#39;eucalyptus&#39;</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;EUCA_KEY_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_dir</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enrc</span><span class="p">))</span> <span class="k">as</span> <span class="n">enrc_content</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">enrc_content</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&quot;^export &quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)):</span>
                                <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="n">tempvar</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                                <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">tempvar</span><span class="p">)</span>
                                <span class="n">value</span> <span class="o">+=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;=&quot;</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EC2_CERT&#39;</span> <span class="ow">or</span> \
                                    <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EC2_PRIVATE_KEY&#39;</span> <span class="ow">or</span> \
                                    <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EUCALYPTUS_CERT&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> does not exist&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
                                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: You must have slurm.conf.in file&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking backup file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backup_file</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_backup_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Backup file is corrupted, or you are using an old&#39;</span>
                        <span class="s">&#39; version of this tool. Please delete this backup file&#39;</span>
                        <span class="s">&#39; and try again.&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking done&#39;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in reading configuration file!&#39;</span>
                     <span class="s">&#39; configuration file not created?&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">MissingSectionHeaderError</span><span class="p">,</span> <span class="n">NoSectionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in reading configuratin file!&#39;</span>
                     <span class="s">&#39; No section header?&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">NoOptionError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in reading configuration file!&#39;</span>
                     <span class="s">&#39; Correct configuration format?&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in reading configuration file!&#39;</span>
                     <span class="s">&#39; Correct python version?&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHOD TO INSTALL</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.check_avaliable"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.check_avaliable">[docs]</a>    <span class="k">def</span> <span class="nf">check_avaliable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if instance is available</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- instance dictionary</span>

<span class="sd">        Return:</span>
<span class="sd">            True -- if instance is available</span>
<span class="sd">            False -- if instance is unavailable</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> uname&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                         <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>

        <span class="n">check_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">check_process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Cluster.euca_start_new_instance"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_start_new_instance">[docs]</a>    <span class="k">def</span> <span class="nf">euca_start_new_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Starts new instance given old instance info using euca2ools</span>

<span class="sd">        Parameter:</span>
<span class="sd">            instance -- old instance</span>
<span class="sd">            instance_index -- instance index</span>
<span class="sd">        Return:</span>
<span class="sd">            new instance</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># try to create a new one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Creating new instance&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">euca_run_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">],</span>
                               <span class="n">instance</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">instance_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting free public IPs&#39;</span><span class="p">)</span>
        <span class="c"># get free IP list</span>
        <span class="n">ip_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_describe_addresses</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">new_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">instance_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Associating IP with </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">new_instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">new_ip</span> <span class="o">=</span> <span class="n">ip_lists</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_lists</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_associate_address</span><span class="p">(</span><span class="n">new_instance</span><span class="p">,</span> <span class="n">new_ip</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in associating IP </span><span class="si">%s</span><span class="s"> with instance </span><span class="si">%s</span><span class="s">, &#39;</span>
                     <span class="s">&#39;trying again&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_ip</span><span class="p">,</span> <span class="n">new_instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">new_instance</span>
</div>
<div class="viewcode-block" id="Cluster.boto_start_new_instance"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.boto_start_new_instance">[docs]</a>    <span class="k">def</span> <span class="nf">boto_start_new_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">instance_index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Starts new instance given old instance info using euca2ools</span>

<span class="sd">        Parameter:</span>
<span class="sd">            instance -- old instance</span>
<span class="sd">            instance_index -- instance index</span>
<span class="sd">        Return:</span>
<span class="sd">            new instance</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">reservation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boto_run_instances</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">],</span>
                                              <span class="mi">1</span><span class="p">,</span>
                                              <span class="n">instance</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">])</span>
        <span class="n">new_instance</span> <span class="o">=</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">arg1</span> <span class="o">=</span> <span class="n">new_instance</span><span class="o">.</span><span class="n">id</span>
        <span class="n">arg2</span> <span class="o">=</span> <span class="n">new_instance</span><span class="o">.</span><span class="n">image_id</span>
        <span class="n">arg3</span> <span class="o">=</span> <span class="n">new_instance</span><span class="o">.</span><span class="n">instance_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_instance</span><span class="p">(</span><span class="n">instance_id</span><span class="o">=</span><span class="n">arg1</span><span class="p">,</span>
                                          <span class="n">image_id</span><span class="o">=</span><span class="n">arg2</span><span class="p">,</span>
                                          <span class="n">instance_type</span><span class="o">=</span><span class="n">arg3</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="n">instance_index</span><span class="p">)</span>
        <span class="n">ip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boto_describe_addresses</span><span class="p">()</span>
        <span class="n">free_public_ip</span> <span class="o">=</span> <span class="n">ip_list</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boto_associate_address</span><span class="p">(</span><span class="n">new_instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">free_public_ip</span><span class="p">)</span>
        <span class="n">new_instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">instance_index</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.euca_change_ip"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_change_ip">[docs]</a>    <span class="k">def</span> <span class="nf">euca_change_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Changes public IP address given instance using euca2ools</span>
<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ip_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_describe_addresses</span><span class="p">()</span>
        <span class="c"># disassociate current one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disassociate_address</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>
        <span class="c"># associate a new random free ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Associating new IP on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">euca_associate_address</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ip_lists</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="n">ip_lists</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="Cluster.boto_change_ip"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.boto_change_ip">[docs]</a>    <span class="k">def</span> <span class="nf">boto_change_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Changes public IP address given instance using boto</span>
<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boto_describe_addresses</span><span class="p">()</span>
        <span class="n">free_public_ip</span> <span class="o">=</span> <span class="n">ip_list</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">disassociate_address</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_instance_from_reservation</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boto_associate_address</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">free_public_ip</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.installation"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.installation">[docs]</a>    <span class="k">def</span> <span class="nf">installation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">max_retry</span><span class="p">,</span> <span class="n">install</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if instances are ready to deploy and installs the</span>
<span class="sd">        softwares on the instance which is ready</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- instance dictionary</span>
<span class="sd">            max_retry -- max number of try for checking instance</span>
<span class="sd">            install -- indicates if need to the installation</span>
<span class="sd">            default: true</span>

<span class="sd">        Logic:</span>
<span class="sd">            ssh reomote host to check if can succeed</span>
<span class="sd">            If install is set to true, installation of</span>
<span class="sd">            SLURM and OpenMPI will start on VM which is ready</span>

<span class="sd">            Each instances associates a count of times for trying</span>
<span class="sd">            If exceeds the max try limit, then gets free public IPs,</span>
<span class="sd">            and associates it with a random new one, reset count to 0</span>

<span class="sd">            Break after all threads are done</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">wait_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ip_change</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># check if ssh port of all VMs are alive for listening</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&#39;pending&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Instance </span><span class="si">%s</span><span class="s"> is pending&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_avaliable</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">del_known_host</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">install</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deploy_services</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;nova&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;ssh in </span><span class="si">%s</span><span class="s"> is closed&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Checking </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">) availability, &#39;</span>
                         <span class="s">&#39;trying </span><span class="si">%d</span><span class="s"> (max try </span><span class="si">%d</span><span class="s">)&#39;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
                            <span class="n">wait_count</span><span class="p">,</span> <span class="n">max_retry</span><span class="p">))</span>

                <span class="n">wait_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">wait_count</span> <span class="o">&gt;</span> <span class="n">max_retry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&#39;shutdown&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&#39;terminate&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&#39;terminated&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">ip_change</span><span class="p">:</span>
                        <span class="c"># get instance index</span>
                        <span class="n">instance_index</span> <span class="o">=</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Instance </span><span class="si">%s</span><span class="s"> creation failed&#39;</span>
                                 <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                        <span class="c"># delete this instance from cloud instance list</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">del_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">terminate_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;euca2ools&#39;</span><span class="p">:</span>
                            <span class="n">instance</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">euca_start_new_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                                                             <span class="n">instance_index</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
                            <span class="n">instance</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">boto_start_new_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                                                             <span class="n">instance_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="n">wait_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">ip_change</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&#39;running&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Trying different IP address on </span><span class="si">%s</span><span class="s">&#39;</span>
                                 <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                        <span class="c"># get free ip addresses</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;euca2ools&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">euca_change_ip</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">boto_change_ip</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;New IP is </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>
                        <span class="n">wait_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">ip_change</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO DO RPCs</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.get_command_result"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.get_command_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_command_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets command output</span>

<span class="sd">        Parameters:</span>
<span class="sd">            command -- shell command</span>

<span class="sd">        Return:</span>
<span class="sd">            Command output</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Cluster.execute"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Executes a command on the instance</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- cloud instance</span>
<span class="sd">            command -- shell command</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> ubuntu@</span><span class="si">%s</span><span class="s"> &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                  <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span> <span class="n">command</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                            <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
                                            <span class="n">command</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Cluster.copyto"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.copyto">[docs]</a>    <span class="k">def</span> <span class="nf">copyto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Copies the named file to the instance</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- cloud instance</span>
<span class="sd">            filename -- the name of file to copy</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;scp -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> ubuntu@</span><span class="si">%s</span><span class="s">:~/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                  <span class="n">filename</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">]))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;scp -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">:~/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                             <span class="n">filename</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                             <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="Cluster.update"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Executes a software update on the specified instance</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- cloud instance</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;sudo apt-get update&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.install"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">packagenames</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Installs the package names that are specified</span>
<span class="sd">        (blank separated on the given instance)</span>

<span class="sd">        Parameter:</span>
<span class="sd">            instance -- cloud instance</span>
<span class="sd">            packagenames -- software names</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;sudo apt-get install --yes &#39;</span>
                     <span class="o">+</span> <span class="n">packagenames</span><span class="p">)</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO CREATE A VIRTUAL CLUSTER</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.ec2_connect"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.ec2_connect">[docs]</a>    <span class="k">def</span> <span class="nf">ec2_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cloud</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create connection</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">cloud</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;nova&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/services/Cloud&quot;</span>
        <span class="k">elif</span> <span class="n">cloud</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;eucalyptus&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/services/Eucalyptus&quot;</span>

        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;EC2_URL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&quot;http://&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">boto</span><span class="o">.</span><span class="n">ec2</span><span class="o">.</span><span class="n">regioninfo</span><span class="o">.</span><span class="n">RegionInfo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">cloud</span><span class="p">,</span>
                                                    <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: error in getting region information&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span> <span class="o">=</span> <span class="n">EC2Connection</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;EC2_ACCESS_KEY&quot;</span><span class="p">),</span>
                                          <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;EC2_SECRET_KEY&quot;</span><span class="p">),</span>
                                          <span class="n">is_secure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                          <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                                          <span class="n">port</span><span class="o">=</span><span class="mi">8773</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: error in connecting to EC2&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Cluster.boto_describe_addresses"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.boto_describe_addresses">[docs]</a>    <span class="k">def</span> <span class="nf">boto_describe_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get all free ip addresses using boto</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ip_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">get_all_addresses</span><span class="p">(</span><span class="n">addresses</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">address_public_ip</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">public_ip</span>
            <span class="n">address_instance_id</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">instance_id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">address_instance_id</span><span class="p">:</span>
                <span class="n">ip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">address_public_ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ip_list</span>
</div>
<div class="viewcode-block" id="Cluster.get_instance_from_reservation"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.get_instance_from_reservation">[docs]</a>    <span class="k">def</span> <span class="nf">get_instance_from_reservation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get instance from reservation</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">r_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">get_all_instances</span><span class="p">(</span><span class="n">instance_ids</span><span class="o">=</span><span class="p">[</span><span class="n">instance_id</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Cluster.boto_associate_address"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.boto_associate_address">[docs]</a>    <span class="k">def</span> <span class="nf">boto_associate_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">address_public_ip</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        associate ip address using boto</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">associate_address</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">address_public_ip</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: Associating ip </span><span class="si">%s</span><span class="s"> with instance </span><span class="si">%s</span><span class="s"> failed, &#39;</span>
                         <span class="s">&#39;trying again&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address_public_ip</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ADDRESS: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">address_public_ip</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_ip_by_id</span><span class="p">(</span><span class="n">instance_id</span><span class="p">,</span> <span class="n">address_public_ip</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.boto_run_instances"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.boto_run_instances">[docs]</a>    <span class="k">def</span> <span class="nf">boto_run_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        run instance usign boto</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">run_instances</span><span class="p">(</span><span class="n">image_id</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
                                               <span class="n">min_count</span><span class="o">=</span><span class="n">cluster_size</span><span class="p">,</span>
                                               <span class="n">max_count</span><span class="o">=</span><span class="n">cluster_size</span><span class="p">,</span>
                                               <span class="n">key_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                                               <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: Error in lunching instances, please try again&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Cluster.euca_run_instance"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_run_instance">[docs]</a>    <span class="k">def</span> <span class="nf">euca_run_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">userkey</span><span class="p">,</span>
        <span class="n">cluster_size</span><span class="p">,</span>
        <span class="n">image</span><span class="p">,</span>
        <span class="n">instance_type</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="bp">None</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        runs instances given parameters</span>

<span class="sd">        Parameters:</span>
<span class="sd">            userkey -- userkey name</span>
<span class="sd">            cluster_size -- number of nodes</span>
<span class="sd">            image -- image id</span>
<span class="sd">            instance_type -- instance type</span>
<span class="sd">            index -- instance key as index</span>
<span class="sd">            default: None</span>

<span class="sd">        Logic:</span>
<span class="sd">            check if all instances are created</span>
<span class="sd">            correctly. program will exit if</span>
<span class="sd">            not all instances required are</span>
<span class="sd">            created, and terminate those which</span>
<span class="sd">            are running already</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">instance_id_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># get run instances store int instances list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;euca-run-instances -k </span><span class="si">%s</span><span class="s"> -n </span><span class="si">%d</span><span class="s"> -t </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">userkey</span><span class="p">,</span>
                      <span class="n">cluster_size</span><span class="p">,</span>
                      <span class="n">instance_type</span><span class="p">,</span>
                      <span class="n">image</span><span class="p">))</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span>
                                             <span class="s">&#39;euca-run-instances -k </span><span class="si">%s</span><span class="s">&#39;</span>
                                             <span class="s">&#39; -n </span><span class="si">%d</span><span class="s"> -t </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">userkey</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span>
                     <span class="n">image</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="c"># find created instance, store into list</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;i-&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is created&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">)</span>
                <span class="n">instance_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if all instances are created&#39;</span><span class="p">)</span>
        <span class="c"># check if all instances are created correctly</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">instance_id_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">cluster_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in creating cluster, please check your input&#39;</span>
                     <span class="s">&#39; or instance limit exceeded?&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">created_instance_id</span> <span class="ow">in</span> <span class="n">instance_id_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminate_instance</span><span class="p">(</span><span class="n">created_instance_id</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking done&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Adding instances into cloud instances list&#39;</span><span class="p">)</span>
        <span class="c"># add instance to instance list</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">instance_id_list</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Adding instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ip_addr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_instance</span><span class="p">(</span><span class="n">instance_id</span><span class="o">=</span><span class="n">ip_addr</span><span class="p">,</span>
                                                  <span class="n">image_id</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
                                                  <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
                                                  <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in creating instances.&#39;</span>
                         <span class="s">&#39; Program will exit&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Cluster.euca_associate_address"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_associate_address">[docs]</a>    <span class="k">def</span> <span class="nf">euca_associate_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">free_ip</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Associates instance with ip</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- cloud instance</span>
<span class="sd">            free_ip -- free public IP address</span>

<span class="sd">        Logic:</span>
<span class="sd">            Associates IP with a given instance, set IP in cloud_instances</span>
<span class="sd">            delete host information in known_hosts if it has</span>

<span class="sd">        Return:</span>
<span class="sd">            false: if association failed</span>
<span class="sd">            trueL: if association succeeded</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;euca-associate-address -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">free_ip</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&#39;euca-associate-address -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
                                      <span class="n">free_ip</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;ADDRESS&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># set ip using instance id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ADDRESS </span><span class="si">%s</span><span class="s"> instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">free_ip</span><span class="p">,</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_ip_by_id</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">free_ip</span><span class="p">)</span>
        <span class="c"># delete host from known_host file in case man-in-middle-attack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting </span><span class="si">%s</span><span class="s"> from known host if it already existed&#39;</span>
                   <span class="o">%</span> <span class="n">free_ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Cluster.disassociate_address"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.disassociate_address">[docs]</a>    <span class="k">def</span> <span class="nf">disassociate_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_ip</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Disassociates IP address</span>

<span class="sd">        Parameters:</span>
<span class="sd">            current_ip -- instance IP which is currently in use</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-disassociates-address to disassociates a</span>
<span class="sd">            given IP address</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Disaasociating </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">current_ip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;euca-disassociate-address </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">current_ip</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;euca-disassociate-address </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">current_ip</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.euca_describe_addresses"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_describe_addresses">[docs]</a>    <span class="k">def</span> <span class="nf">euca_describe_addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return list of free public IP addresses</span>

<span class="sd">        No parameters</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-describe-addresses to get all the IP addresses,</span>
<span class="sd">            filter those which are currently in use</span>

<span class="sd">        Return:</span>
<span class="sd">            ip_list -- a list of free public IP addresses</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ip_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&#39;euca-describe-addresses&#39;</span>
               <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)]</span>

        <span class="c"># store free ip into ip list for return</span>
        <span class="k">for</span> <span class="n">free_ip</span> <span class="ow">in</span> <span class="n">ips</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">free_ip</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;i-&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">free_ip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">free_ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ip_list</span>
</div>
<div class="viewcode-block" id="Cluster.if_status"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.if_status">[docs]</a>    <span class="k">def</span> <span class="nf">if_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if instance is running</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&#39;euca-describe-instances&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span></div>
<div class="viewcode-block" id="Cluster.euca_get_ip"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_get_ip">[docs]</a>    <span class="k">def</span> <span class="nf">euca_get_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get instance public given instance id</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&#39;euca-describe-instances&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">instance_id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;pending&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Cluster.create_cluster"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.create_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">create_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for creating cluster</span>

<span class="sd">        Parameters:</span>
<span class="sd">            args -- this method deals</span>
<span class="sd">                    args.name: cluster name</span>
<span class="sd">                    args.number: cluster compute nodes number</span>
<span class="sd">                    args.typy: instance type</span>
<span class="sd">                    args,image: image id</span>

<span class="sd">        Logic:</span>
<span class="sd">            Check existence before creation of cluster</span>
<span class="sd">            If cluster was created before, only start creating</span>
<span class="sd">            if status is DOWN</span>

<span class="sd">            Save each instance into cloud instance list</span>
<span class="sd">            Associate IP with each instance</span>
<span class="sd">            Create source list file if using IU ubuntu repository</span>
<span class="sd">            Delete source list file after installtion and configuration</span>
<span class="sd">            of SLURM and OpenMPI</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if </span><span class="si">%s</span><span class="s"> is existed&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_exist</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="c"># if exists, get cloud info by name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is existed, gettting it from backup file&#39;</span>
                       <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c"># if cluster is terminated, delete old info, start over</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if </span><span class="si">%s</span><span class="s"> is currently down&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">DOWN</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting old info&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">del_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in creating cluster </span><span class="si">%s</span><span class="s">,name is in use&#39;</span>
                          <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">cluster_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Cluster size is (control node included): </span><span class="si">%d</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="n">cluster_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_section</span><span class="p">(</span><span class="s">&#39;Creating virtual cluster&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;cluster name    -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;numbe of nodes  -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cluster_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;instance type   -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;image id        -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Creating new cloud instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># set cloud instance list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Creating cluster&#39;</span><span class="p">)</span>
        <span class="c"># run instances given parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;euca2ools&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">euca_run_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                                   <span class="n">args</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="c"># immediatly associate ip after run instance</span>
            <span class="c"># may lead to error, use sleep</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;nova&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting free public IPs&#39;</span><span class="p">)</span>
                <span class="c"># get free IP list</span>
                <span class="n">ip_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_describe_addresses</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Associating public IP addresses&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">):</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_associate_address</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ip_lists</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in associating IP </span><span class="si">%s</span><span class="s"> with instance </span><span class="si">%s</span><span class="s">, &#39;</span>
                                 <span class="s">&#39;trying again&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip_lists</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
            <span class="c"># eucalyptus no need to associate ip</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;eucalyptus&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">):</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_ip_by_id</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">euca_get_ip</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
            <span class="n">reservation</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">boto_run_instances</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">cluster_size</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Associating public IPs&#39;</span><span class="p">)</span>
            <span class="n">ip_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">reservation</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_instance</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="n">instance</span><span class="o">.</span><span class="n">image_id</span><span class="p">,</span>
                                                  <span class="n">instance</span><span class="o">.</span><span class="n">instance_type</span><span class="p">)</span>
                <span class="n">free_public_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boto_describe_addresses</span><span class="p">()[</span><span class="n">ip_index</span><span class="p">]</span>
                <span class="n">ip_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">boto_associate_address</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">free_public_ip</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Creating IU ubunto repo source list&#39;</span><span class="p">)</span>
        <span class="c"># choose repo, by defalt, using IU ubuntu repo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_repo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking alive instance for deploying&#39;</span><span class="p">)</span>
        <span class="c"># detect if VMs are ready for deploy</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">installation</span><span class="p">,</span>
                                 <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="bp">True</span><span class="p">])</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Configuraing SLURM&#39;</span><span class="p">)</span>
        <span class="c"># config SLURM system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_slurm</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Cleaning up&#39;</span><span class="p">)</span>
        <span class="c"># clean repo file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_repo</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Saving cloud instance into backup file&#39;</span><span class="p">)</span>
        <span class="c"># save cloud instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">save_instances</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Done creation of cluster&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.clean_repo"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.clean_repo">[docs]</a>    <span class="k">def</span> <span class="nf">clean_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove source list file</span>

<span class="sd">        No parameters:</span>

<span class="sd">        Logic:</span>
<span class="sd">            If if_default flag is set to false, then delete</span>
<span class="sd">            source list file</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Removing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.config_slurm"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.config_slurm">[docs]</a>    <span class="k">def</span> <span class="nf">config_slurm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_key</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Configures slurm</span>

<span class="sd">        Parameters:</span>
<span class="sd">            create_key -- indicates whether to create munge-key</span>
<span class="sd">            default: true, creates key</span>

<span class="sd">        Logic:</span>
<span class="sd">            Reads slurm configuration input file, substitutes controlMachine</span>
<span class="sd">            with control machine id. Append each computation node into</span>
<span class="sd">            configuration file in COMPUTE NODES section</span>
<span class="sd">            Generates munge-key on control node if flag is set to true</span>
<span class="sd">            Does configuration on each node in parallel</span>
<span class="sd">            After all threads are done, removes temp files</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">slurm_conf_file</span> <span class="o">=</span> <span class="s">&#39;slurm.conf&#39;</span>
        <span class="n">munge_key_file</span> <span class="o">=</span> <span class="s">&#39;munge.key&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Opening </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">slurm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Configuring slurm.conf&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slurm</span><span class="p">))</span> <span class="k">as</span> <span class="n">srcf</span><span class="p">:</span>
            <span class="n">input_content</span> <span class="o">=</span> <span class="n">srcf</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">srcf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting control machie id&#39;</span><span class="p">)</span>
        <span class="c"># set control machine</span>
        <span class="n">controlMachine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_content</span><span class="p">)</span> <span class="o">%</span> <span class="nb">vars</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Control node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">controlMachine</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Writting into </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">slurm_conf_file</span><span class="p">)</span>
        <span class="c"># write control machine into slurm.conf file</span>
        <span class="n">destf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">slurm_conf_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">destf</span><span class="p">,</span> <span class="n">output</span>
        <span class="n">destf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Openning </span><span class="si">%s</span><span class="s"> for adding computation nodes&#39;</span>
                   <span class="o">%</span> <span class="n">slurm_conf_file</span><span class="p">)</span>
        <span class="c"># add compute machines to slurm conf file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">slurm_conf_file</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">controlMachine</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Adding instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;NodeName=</span><span class="si">%s</span><span class="s"> Procs=1 State=UNKNOWN</span><span class="se">\n</span><span class="s">&#39;</span>
                                   <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;PartitionName=debug Nodes=</span><span class="si">%s</span><span class="s"> Default=YES&#39;</span>
                        <span class="s">&#39; MaxTime=INFINITE State=UP</span><span class="se">\n</span><span class="s">&#39;</span>
                                    <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># if needs to create munge key</span>
        <span class="k">if</span> <span class="n">create_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Generating munge-key&#39;</span><span class="p">)</span>

            <span class="c"># generate munge-key on control node</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                         <span class="s">&#39;sudo /usr/sbin/create-munge-key&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Opening </span><span class="si">%s</span><span class="s"> for writting munge-key&#39;</span> <span class="o">%</span> <span class="n">munge_key_file</span><span class="p">)</span>
            <span class="n">munge_key</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">munge_key_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">munge_key</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&quot;</span>
                                        <span class="s">&quot; &#39;sudo cat /etc/munge/munge.key&#39;&quot;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s">&#39;ip&#39;</span>
                                        <span class="p">]))</span>
            <span class="n">munge_key</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># copy SLURM conf file to every node</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Starting SLURM on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">process_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_slurm</span><span class="p">,</span>
                                                  <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">,</span>
                                                        <span class="n">create_key</span><span class="p">,</span>
                                                        <span class="n">slurm_conf_file</span><span class="p">,</span>
                                                        <span class="n">munge_key_file</span><span class="p">])</span>
                <span class="n">process_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c"># wait all threads are done</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Waitting all threads are done&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># clean temp files</span>
        <span class="k">if</span> <span class="n">create_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Removing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">munge_key_file</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">munge_key_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Removing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">slurm_conf_file</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">slurm_conf_file</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.start_slurm"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.start_slurm">[docs]</a>    <span class="k">def</span> <span class="nf">start_slurm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">instance</span><span class="p">,</span>
                    <span class="n">create_key</span><span class="p">,</span>
                    <span class="n">slurm_conf_file</span><span class="p">,</span>
                    <span class="n">munge_key_file</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Copies SLURM configuration file and munge key file</span>
<span class="sd">        to every node, and start slurm on each node</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- cloud instance</span>
<span class="sd">            create_key -- flag indicates whether needs to create munge key</span>
<span class="sd">            slurm_conf_file -- SLURM configuration file name</span>
<span class="sd">            munge_key_file -- munge key file name</span>

<span class="sd">        Logic:</span>
<span class="sd">            Copies SLURM configuration file to each node in cluster.</span>
<span class="sd">            If needs to create munge key, then creates munge key on</span>
<span class="sd">            control node, copies it to each node in cluster. Starts</span>
<span class="sd">            SLURM and munge after copy is done</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># copy slurm.conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Copying slurm.conf to node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">slurm_conf_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;sudo cp slurm.conf /etc/slurm-llnl&#39;</span><span class="p">)</span>

        <span class="c"># copy munge key</span>
        <span class="k">if</span> <span class="n">create_key</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Copying munge-key to node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">munge_key_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                         <span class="s">&#39;sudo cp munge.key /etc/munge/munge.key&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                         <span class="s">&#39;sudo chown munge /etc/munge/munge.key&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                         <span class="s">&#39;sudo chgrp munge /etc/munge/munge.key&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span>
                         <span class="s">&#39;sudo chmod 400 /etc/munge/munge.key&#39;</span><span class="p">)</span>

        <span class="c"># start slurm and munge daemon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Starting slurm on node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;sudo /etc/init.d/slurm-llnl start&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;sudo /etc/init.d/munge start&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.define_repo"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.define_repo">[docs]</a>    <span class="k">def</span> <span class="nf">define_repo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set ubuntu repo to IU ubuntu repository</span>

<span class="sd">        No parameters</span>

<span class="sd">        Source list file content:</span>
<span class="sd">        -------------------------</span>

<span class="sd">        deb http://ftp.ussg.iu.edu/linux/ubuntu/ natty-updates main</span>
<span class="sd">        deb-src http://ftp.ussg.iu.edu/linux/ubuntu/ natty-updates main</span>
<span class="sd">        deb http://ftp.ussg.iu.edu/linux/ubuntu/ natty universe</span>
<span class="sd">        deb-src http://ftp.ussg.iu.edu/linux/ubuntu/ natty universe</span>
<span class="sd">        deb http://ftp.ussg.iu.edu/linux/ubuntu/ natty-updates universe</span>
<span class="sd">        deb-src http://ftp.ussg.iu.edu/linux/ubuntu/ natty-updates universe</span>
<span class="sd">        deb http://ftp.ussg.iu.edu/linux/ubuntu/ natty main</span>
<span class="sd">        deb-src http://ftp.ussg.iu.edu/linux/ubuntu/ natty main</span>

<span class="sd">        Logic:</span>
<span class="sd">            If uses IU ubuntu repository, creates sources_list file</span>
<span class="sd">            which has the former content</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">iu_repo</span> <span class="o">=</span> <span class="s">&#39;http://ftp.ussg.iu.edu/linux/ubuntu/&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Using default repository&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Using IU ubuntu repository&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Using </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">iu_repo</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Opening </span><span class="si">%s</span><span class="s"> for writting&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty-updates main</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb-src &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty-updates main</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty universe</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb-src &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty universe</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty-updates universe</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb-src &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span>
                             <span class="s">&#39; natty-updates universe</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty main</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;deb-src &#39;</span> <span class="o">+</span> <span class="n">iu_repo</span> <span class="o">+</span> <span class="s">&#39; natty main</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">source</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Cluster.deploy_services"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.deploy_services">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Deploies SLURM and OpenMPI services</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance -- cloud instance</span>

<span class="sd">        Logic:</span>
<span class="sd">            If using IU ubuntu repository, then copies source_list</span>
<span class="sd">            to each instance in the cluster, installs SLURM and</span>
<span class="sd">            OpenMPI on the instance</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Installing SLURM system and OpenMPI on </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
                 <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">if_default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Copying </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">,</span>
                                             <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;sudo cp </span><span class="si">%s</span><span class="s"> /etc/apt/&#39;</span>
                         <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Updating on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
        <span class="c"># install SLURM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Installing slrum-llnl on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;slurm-llnl&#39;</span><span class="p">)</span>
        <span class="c"># install OpenMPI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Installing openmpi on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&quot;openmpi-bin libopenmpi-dev&quot;</span><span class="p">)</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO SAVE RUNNING VIRTUAL CLUSTER</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.save_instance"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.save_instance">[docs]</a>    <span class="k">def</span> <span class="nf">save_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">kernel_id</span><span class="p">,</span>
        <span class="n">ramdisk_id</span><span class="p">,</span>
        <span class="n">instance_ip</span><span class="p">,</span>
        <span class="n">instance_name</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Saves one instance</span>

<span class="sd">        Parameters:</span>
<span class="sd">            kernel_id: image kernel id</span>
<span class="sd">            ramdisk_id: image ramdisk id</span>
<span class="sd">            instance_ip: instance public IP address</span>
<span class="sd">            instance_name: image name</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-bundle-vol to create a bundle of current image on</span>
<span class="sd">            a remote host. Image has the size of 1GB, and stored under /mnt/</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">kernel_id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                       <span class="s">&quot; sudo euca-bundle-vol -c ${EC2_CERT}&quot;</span>
                       <span class="s">&quot; -k ${EC2_PRIVATE_KEY} -u ${EC2_USER_ID}&quot;</span>
                       <span class="s">&quot; --ec2cert ${EUCALYPTUS_CERT} --no-inherit&quot;</span>
                       <span class="s">&quot; -p </span><span class="si">%s</span><span class="s"> -s 1024 -d /mnt/&#39;&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                          <span class="n">instance_ip</span><span class="p">,</span>
                          <span class="n">instance_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                            <span class="s">&quot; sudo euca-bundle-vol -c ${EC2_CERT}&quot;</span>
                            <span class="s">&quot; -k ${EC2_PRIVATE_KEY} -u ${EC2_USER_ID}&quot;</span>
                            <span class="s">&quot; --ec2cert ${EUCALYPTUS_CERT} --no-inherit&quot;</span>
                            <span class="s">&quot; -p </span><span class="si">%s</span><span class="s"> -s 1024 -d /mnt/&#39;&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                <span class="n">instance_ip</span><span class="p">,</span>
                                <span class="n">instance_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">ramdisk_id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                       <span class="s">&quot; sudo euca-bundle-vol -c ${EC2_CERT}&quot;</span>
                       <span class="s">&quot; -k ${EC2_PRIVATE_KEY} -u ${EC2_USER_ID}&quot;</span>
                       <span class="s">&quot; --ec2cert ${EUCALYPTUS_CERT} --no-inherit&quot;</span>
                       <span class="s">&quot; -p </span><span class="si">%s</span><span class="s"> -s 1024 -d /mnt/ --kernel </span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                          <span class="n">instance_ip</span><span class="p">,</span>
                          <span class="n">instance_name</span><span class="p">,</span>
                          <span class="n">kernel_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                            <span class="s">&quot; sudo euca-bundle-vol -c ${EC2_CERT}&quot;</span>
                            <span class="s">&quot; -k ${EC2_PRIVATE_KEY} -u ${EC2_USER_ID}&quot;</span>
                            <span class="s">&quot; --ec2cert ${EUCALYPTUS_CERT} --no-inherit&quot;</span>
                            <span class="s">&quot; -p </span><span class="si">%s</span><span class="s"> -s 1024 -d /mnt/ --kernel </span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                <span class="n">instance_ip</span><span class="p">,</span>
                                <span class="n">instance_name</span><span class="p">,</span>
                            <span class="n">kernel_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                       <span class="s">&quot; sudo euca-bundle-vol -c ${EC2_CERT}&quot;</span>
                       <span class="s">&quot; -k ${EC2_PRIVATE_KEY} -u ${EC2_USER_ID}&quot;</span>
                       <span class="s">&quot; --ec2cert ${EUCALYPTUS_CERT} --no-inherit&quot;</span>
                       <span class="s">&quot; -p </span><span class="si">%s</span><span class="s"> -s 1024 -d /mnt/ --kernel </span><span class="si">%s</span><span class="s"> --ramdisk </span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                          <span class="n">instance_ip</span><span class="p">,</span>
                          <span class="n">instance_name</span><span class="p">,</span>
                          <span class="n">kernel_id</span><span class="p">,</span>
                          <span class="n">ramdisk_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                            <span class="s">&quot; sudo euca-bundle-vol -c ${EC2_CERT}&quot;</span>
                            <span class="s">&quot; -k ${EC2_PRIVATE_KEY} -u ${EC2_USER_ID}&quot;</span>
                            <span class="s">&quot; --ec2cert ${EUCALYPTUS_CERT} --no-inherit&quot;</span>
                            <span class="s">&quot; -p </span><span class="si">%s</span><span class="s"> -s 1024 -d /mnt/ --kernel </span><span class="si">%s</span><span class="s"> --ramdisk </span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                                <span class="n">instance_ip</span><span class="p">,</span>
                                <span class="n">instance_name</span><span class="p">,</span>
                                <span class="n">kernel_id</span><span class="p">,</span>
                                <span class="n">ramdisk_id</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Cluster.upload_bundle"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.upload_bundle">[docs]</a>    <span class="k">def</span> <span class="nf">upload_bundle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instance_ip</span><span class="p">,</span>
        <span class="n">bucket_name</span><span class="p">,</span>
        <span class="n">manifest</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uploads bundle image given manifest</span>

<span class="sd">        Parameters:</span>
<span class="sd">            instance_ip -- instance public IP address</span>
<span class="sd">            bucket_name -- bucket name for bundled image</span>
<span class="sd">            manifest -- manifest for bundled image</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-upload-bundle to upload bundle</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                   <span class="s">&quot; euca-upload-bundle -b </span><span class="si">%s</span><span class="s"> -m </span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                      <span class="n">instance_ip</span><span class="p">,</span>
                      <span class="n">bucket_name</span><span class="p">,</span>
                      <span class="n">manifest</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&quot;ssh -i </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s"> &#39;. ~/.profile;&quot;</span>
                        <span class="s">&quot; euca-upload-bundle -b </span><span class="si">%s</span><span class="s"> -m </span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userkey</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">user_login</span><span class="p">,</span>
                            <span class="n">instance_ip</span><span class="p">,</span>
                            <span class="n">bucket_name</span><span class="p">,</span>
                            <span class="n">manifest</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Cluster.describe_images"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.describe_images">[docs]</a>    <span class="k">def</span> <span class="nf">describe_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets image infomation</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image_id -- image id</span>

<span class="sd">        Logic:</span>
<span class="sd">            Uses euca-describe-images to get all the inforamtion of image</span>
<span class="sd">            given image id</span>

<span class="sd">        Return:</span>
<span class="sd">            Command result of euca-describe-images of given image id</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;euca-describe-images </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">image_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&#39;euca-describe-images </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">image_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.get_kernel_id"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.get_kernel_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_kernel_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets kernel id</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image_id -- image id</span>

<span class="sd">        Logic:</span>
<span class="sd">            Parses the command results returned by describe image method.</span>
<span class="sd">            Given that sometimes kernel id is empty for certain images,</span>
<span class="sd">            checks if the command returens a kernel id before return it</span>

<span class="sd">        Return:</span>
<span class="sd">            kernal id -- kernal id is the 8th element of returned command</span>
<span class="sd">                         result</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">command_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">describe_images</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Kernel ID </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">command_result</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">command_result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Cluster.get_ramdisk_id"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.get_ramdisk_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_ramdisk_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets ramdisk id</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image_id -- image id</span>

<span class="sd">        Logic:</span>
<span class="sd">            Parses the command results returned by describe image method.</span>
<span class="sd">            Given that sometimes ramdisk id is empty for certain images,</span>
<span class="sd">            checks if the command returens a ramdisk id before return it</span>

<span class="sd">        Return:</span>
<span class="sd">            ramdisk id -- ramdisk id is the 9th element of returned command</span>
<span class="sd">                          result</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">command_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">describe_images</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">command_result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Ramdisk ID </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">command_result</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">command_result</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Cluster.save_node"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.save_node">[docs]</a>    <span class="k">def</span> <span class="nf">save_node</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_id</span><span class="p">,</span>
        <span class="n">instance_ip</span><span class="p">,</span>
        <span class="n">bucket_name</span><span class="p">,</span>
        <span class="n">image_name</span><span class="p">,</span>
        <span class="n">node_type</span><span class="p">,</span>
        <span class="n">out_queue</span>
        <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Saves nodem, upload and register</span>

<span class="sd">        Parameters:</span>
<span class="sd">            image_id -- image id of instance</span>
<span class="sd">            instance_ip -- instance public IP address</span>
<span class="sd">            bucket_name -- bucket name for bundled image</span>
<span class="sd">            image_name -- image name for bundled image</span>
<span class="sd">            node_type -- control node or compute node</span>
<span class="sd">            out_queue -- queue in which puts output</span>

<span class="sd">        Logic:</span>
<span class="sd">            After gets all the necessary infomraion to save bundle a node,</span>
<span class="sd">            then saves the node, uploads the bundle</span>

<span class="sd">        Return:</span>
<span class="sd">            bundled image id -- Parses the command result, gets the bundled</span>
<span class="sd">                                image id, then returns it</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">bundled_image_id</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">kernel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kernel_id</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Kernel ID </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kernel_id</span><span class="p">)</span>
        <span class="n">ramdisk_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ramdisk_id</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Ramdisk ID </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ramdisk_id</span><span class="p">)</span>
        <span class="c"># get manifest from the last unit</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_instance</span><span class="p">(</span><span class="n">kernel_id</span><span class="p">,</span>
                    <span class="n">ramdisk_id</span><span class="p">,</span> <span class="n">instance_ip</span><span class="p">,</span> <span class="n">image_name</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Manifest generated: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">manifest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Uploading bundle&#39;</span><span class="p">)</span>

        <span class="c"># upload image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_bundle</span><span class="p">(</span><span class="n">instance_ip</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">,</span>
                 <span class="n">manifest</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Uploading done&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Registering image&#39;</span><span class="p">)</span>

        <span class="c"># register image, and return image id</span>
        <span class="n">bundled_image_id</span><span class="p">[</span><span class="n">node_type</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">euca_register</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">out_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">bundled_image_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.euca_register"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.euca_register">[docs]</a>    <span class="k">def</span> <span class="nf">euca_register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;register image&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_result</span><span class="p">(</span><span class="s">&#39;euca-register </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">image</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.checkpoint_cluster"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.checkpoint_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">checkpoint_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for saving virtual cluster</span>

<span class="sd">        Parameters:</span>
<span class="sd">            args -- this method deals with</span>
<span class="sd">                    args.name -- virtual cluster name</span>
<span class="sd">                    args.controlb -- control node bucket name</span>
<span class="sd">                    args.controln -- control node image name</span>
<span class="sd">                    args.computeb -- compute node bucket name</span>
<span class="sd">                    args.computen -- compute node image name</span>

<span class="sd">        Logic;</span>
<span class="sd">            Checks existence before saving virtual cluster</span>
<span class="sd">            Only saves cluster which is running (Because saved and</span>
<span class="sd">            terminated clusters are not currenly running)</span>
<span class="sd">            Only saves control node and one compute node into images</span>
<span class="sd">            Saves new control node image id and new compute node image id</span>
<span class="sd">            into backup file for later restore. Change status to SAVED after</span>
<span class="sd">            the saving. Then terminates cluster before deletes host information</span>
<span class="sd">            after each termination</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;UNIMPLEMENTED&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;eucalyptus&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;bugs&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if </span><span class="si">%s</span><span class="s"> is existed&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># check if cluter is existed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_exist</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="c"># get cluter by name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting cloud instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c"># if cluster is down, terminate the program</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in locating virtual cluster </span><span class="si">%s</span><span class="s">, not running?&#39;</span>
                          <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in locating virtual cluster </span><span class="si">%s</span><span class="s">, not created?&#39;</span>
                     <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_section</span><span class="p">(</span><span class="s">&#39;Saving virtual cluster&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Virtual cluster name -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;control node bucket  -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">controlb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;control node name    -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">controln</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;compute node bucket  -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">computeb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;compute node name    -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">computen</span><span class="p">)</span>

        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">compute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Control node </span><span class="si">%s</span><span class="s">, compute node </span><span class="si">%s</span><span class="s">&#39;</span>
                   <span class="o">%</span> <span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">compute</span><span class="p">))</span>

        <span class="c"># copy necessary files to instances, and source profile</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="p">[</span><span class="n">control</span><span class="p">,</span> <span class="n">compute</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;EC2_CERT&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;EC2_PRIVATE_KEY&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;EUCALYPTUS_CERT&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;cat </span><span class="si">%s</span><span class="s"> &gt;&gt; ~/.profile&#39;</span>
                         <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;source ~/.profile&#39;</span><span class="p">)</span>

        <span class="n">save_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Saving control node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">control</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_node</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">control</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">],</span>
                                                      <span class="n">control</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
                                                      <span class="n">args</span><span class="o">.</span><span class="n">controlb</span><span class="p">,</span>
                                                      <span class="n">args</span><span class="o">.</span><span class="n">controln</span><span class="p">,</span>
                                                      <span class="s">&#39;control&#39;</span><span class="p">,</span>
                                                      <span class="n">save_queue</span>
                                                      <span class="p">])</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Saving compute node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">compute</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_node</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">compute</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">],</span>
                                                      <span class="n">compute</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span>
                                                      <span class="n">args</span><span class="o">.</span><span class="n">computeb</span><span class="p">,</span>
                                                      <span class="n">args</span><span class="o">.</span><span class="n">computen</span><span class="p">,</span>
                                                      <span class="s">&#39;compute&#39;</span><span class="p">,</span>
                                                      <span class="n">save_queue</span>
                                                      <span class="p">])</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># return values has the format:</span>
        <span class="c"># {&#39;control&#39;:&#39;&#39;, &#39;compute&#39;:&#39;&#39;}, but not sure the order</span>
        <span class="k">for</span> <span class="n">bundled_image_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">save_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">save_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()]:</span>
            <span class="k">if</span> <span class="s">&#39;control&#39;</span> <span class="ow">in</span> <span class="n">bundled_image_id</span><span class="p">:</span>
                <span class="n">control_node_id</span> <span class="o">=</span> <span class="n">bundled_image_id</span><span class="p">[</span><span class="s">&#39;control&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s">&#39;compute&#39;</span> <span class="ow">in</span> <span class="n">bundled_image_id</span><span class="p">:</span>
                <span class="n">compute_node_id</span> <span class="o">=</span> <span class="n">bundled_image_id</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">]</span>

        <span class="c"># get instance type</span>
        <span class="n">instance_type</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Instance type </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance_type</span><span class="p">)</span>
        <span class="c"># get compute node number</span>
        <span class="n">cluster_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cluster_size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Number of computation nodes </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cluster_size</span><span class="p">)</span>
        <span class="c"># copy list for termination</span>
        <span class="n">temp_instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c"># delete old info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting </span><span class="si">%s</span><span class="s"> from backup file&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">del_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Setting save info&#39;</span><span class="p">)</span>
        <span class="c"># set saved cloud info, and change status to saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">checkpoint_cloud_instances</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                        <span class="n">control_node_id</span><span class="p">,</span>
                                                        <span class="n">compute_node_id</span><span class="p">,</span>
                                                        <span class="n">instance_type</span><span class="p">,</span>
                                                        <span class="n">cluster_size</span><span class="p">)</span>
        <span class="c"># save cluster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Saving cluster into backup file&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">save_instances</span><span class="p">()</span>

        <span class="c"># terminate instances</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">temp_instance_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminate_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">del_known_host</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>
<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO RESTORE VIRTUAL CLUSTER</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.restore_cluster"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.restore_cluster">[docs]</a>    <span class="k">def</span> <span class="nf">restore_cluster</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for restoring cluster</span>

<span class="sd">        Parameters:</span>
<span class="sd">            args -- this method deals with</span>
<span class="sd">                    args.name -- virtual cluster name</span>

<span class="sd">        Logic:</span>
<span class="sd">            Loads control node id, compute node id, instance type,</span>
<span class="sd">            cluster size from backup file.</span>
<span class="sd">            Creates cluster of size one using control node id</span>
<span class="sd">            Creates cluster of cluster size using compute node id</span>
<span class="sd">            Associates IP addresses with all created instances</span>
<span class="sd">            Granted cluster was saved before, so no need to install</span>
<span class="sd">            softwares again, but need to configure SLURM accordingly</span>
<span class="sd">            because all host names changed. No need to create mumge-key</span>
<span class="sd">            because munge-key was also saved in each instance during the</span>
<span class="sd">            saving process.</span>

<span class="sd">            Change status to RUN in the end, and save this restored cluster</span>
<span class="sd">            infomation into backup file</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;UNIMPLEMENTED&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud</span> <span class="o">==</span> <span class="s">&#39;eucalyptus&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;bugs&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        
        <span class="n">control_node_num</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># only restore cluster which is saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if </span><span class="si">%s</span><span class="s"> is existed&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_exist</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting cloud </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">SAVED</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Cloud status: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">SAVED</span><span class="p">)</span>
                <span class="c"># if cluster is saved, delete old cluster, and create a</span>
                <span class="c"># new cloud instance for deploying</span>
                <span class="n">control_node_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;control&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;control node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">control_node_id</span><span class="p">)</span>
                <span class="n">compute_node_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;compute&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;compute node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">compute_node_id</span><span class="p">)</span>
                <span class="n">instance_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;type&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;instance type </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance_type</span><span class="p">)</span>
                <span class="n">cluster_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;cluster size </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cluster_size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Creating new cloud instance list&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting old info from backup file&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in restoring virtual cluster </span><span class="si">%s</span><span class="s">, not saved?&#39;</span>
                          <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in locating virtual cluster </span><span class="si">%s</span><span class="s">, not created?&#39;</span>
                     <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">cluster_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">control_node_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_section</span><span class="p">(</span><span class="s">&#39;Restoring virtual cluster&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;cluster name      -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;number of nodes   -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cluster_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;instance type     -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;control image     -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">control_node_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;compute image     -- </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">compute_node_id</span><span class="p">)</span>

        <span class="c"># run control node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Creating control node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">control_node_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">euca_run_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">control_node_num</span><span class="p">,</span>
                               <span class="n">control_node_id</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">)</span>
        <span class="c"># run compute nodes given number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Creating compute node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">compute_node_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">euca_run_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">cluster_size</span> <span class="o">-</span> <span class="n">control_node_num</span><span class="p">,</span>
                               <span class="n">compute_node_id</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">)</span>

        <span class="c"># get free ip list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting free IP list&#39;</span><span class="p">)</span>
        <span class="n">ip_lists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_describe_addresses</span><span class="p">()</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Associating IPs&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_size</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting cloud from index </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">euca_associate_address</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">ip_lists</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in associating IP </span><span class="si">%s</span><span class="s"> with instance </span><span class="si">%s</span><span class="s">, &#39;</span>
                     <span class="s">&#39;trying again&#39;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">ip_lists</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]))</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># check ssh port but not install</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking alive instance for deploying&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">installation</span><span class="p">,</span>
                                 <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">instance</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">activeCount</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># cnfig SLURM but not generating munge-keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Configuating SLURM&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_slurm</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># set status to run and save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Setting status to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">RUN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">RUN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting old cloud instance info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">del_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Saving cloud instance info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">save_instances</span><span class="p">()</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO TERMINATE NAD CLEANUP</span>
<span class="c"># ---------------------------------------------------------------------</span></div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Cluster.del_known_host"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.del_known_host">[docs]</a>    <span class="k">def</span> <span class="nf">del_known_host</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Deletes known host info from ~/.ssh/known_hosts</span>

<span class="sd">        Parameter:</span>
<span class="sd">            ip_addr -- IP address</span>

<span class="sd">        Logic:</span>
<span class="sd">            Deletes known host information from ~/.ssh/known_hosts</span>
<span class="sd">            in case it shows man-in-middle-attack message when starts</span>
<span class="sd">            different cluster but using the same IP addresses</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">known_hosts</span> <span class="o">=</span> <span class="s">&#39;~/.ssh/known_hosts&#39;</span>
<span class="c">#        self.msg(&#39;Deleting host info from known_hosts&#39;)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">known_hosts</span><span class="p">))</span> <span class="k">as</span> <span class="n">srcf</span><span class="p">:</span>
            <span class="n">host_list</span> <span class="o">=</span> <span class="n">srcf</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">srcf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">known_hosts</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destf</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">host_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">destf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="n">destf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Cluster.terminate_instance"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.terminate_instance">[docs]</a>    <span class="k">def</span> <span class="nf">terminate_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;terminate instance given instance id&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Terminating instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;euca2ools&#39;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;euca-terminate-instances </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">instance_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">==</span> <span class="s">&#39;boto&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ec2_conn</span><span class="o">.</span><span class="n">terminate_instances</span><span class="p">([</span><span class="n">instance_id</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;ERROR: terminat instance </span><span class="si">%s</span><span class="s"> failed&#39;</span> <span class="o">%</span> <span class="n">instance_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Cluster.shut_down"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.shut_down">[docs]</a>    <span class="k">def</span> <span class="nf">shut_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method for shutting down a cluster</span>

<span class="sd">        Parameters:</span>
<span class="sd">            args -- this method deals with</span>
<span class="sd">                    args.name -- virtual cluster name</span>

<span class="sd">        Logic:</span>
<span class="sd">            Only terminates cloud instance which is not terminated</span>
<span class="sd">            Checking its existence before termination.</span>
<span class="sd">            Delete host info from ~/.ssh/known_hosts after each termination</span>
<span class="sd">            Change status according to following:</span>
<span class="sd">                If current status is SAVED, then does not change status</span>
<span class="sd">                If current status is RUN, then changes it to DOWN</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># only terminate cluster which is not terminated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking if </span><span class="si">%s</span><span class="s"> is existed&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_exist</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Getting cloud instance </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Checking cloud status&#39;</span><span class="p">)</span>
            <span class="c"># check if cloud instance is terminated</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">DOWN</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in terminating cluster </span><span class="si">%s</span><span class="s">, already down?&#39;</span>
                          <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error in finding virtual cluster </span><span class="si">%s</span><span class="s">, not created?&#39;</span>
                     <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminate_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">del_known_host</span><span class="p">(</span><span class="n">instance</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">])</span>

        <span class="c"># change status to terminated, and save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;If status is </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">RUN</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">RUN</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Setting status to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">DOWN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">DOWN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting instance old info&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">del_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Saving instance into backup file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">save_instances</span><span class="p">()</span>
<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO SHOW VIRTUAL CLUSTER(S) STATUS</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.show_status"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.show_status">[docs]</a>    <span class="k">def</span> <span class="nf">show_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Show status of cluster(s)</span>

<span class="sd">        Parameters:</span>
<span class="sd">            args -- this method deals with</span>
<span class="sd">                    args.name -- virtual cluster name</span>

<span class="sd">        Logic:</span>
<span class="sd">            Reads from backup file to load cluster information given</span>
<span class="sd">            cluster name. If cluster name is specified, then after</span>
<span class="sd">            checks its existence, loads it to display. If no cluster</span>
<span class="sd">            name is specified, then loads all cluster instances to</span>
<span class="sd">            display. If no clusters are saved in the backup file, after</span>
<span class="sd">            prints help message, then quits the program</span>

<span class="sd">        No returns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="c"># get all cloud intances</span>
            <span class="n">cloud_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_all_cloud_instances</span><span class="p">()</span>
            <span class="c"># if no cloud instances created, then prints msg and quits</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cloud_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">You do not have any virtual clusters&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cloud</span> <span class="ow">in</span> <span class="n">cloud_set</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">====================================&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Virtual Cluster </span><span class="si">%s</span><span class="s"> (status: </span><span class="si">%s</span><span class="s">)&#39;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;====================================&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">SAVED</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Control node -- </span><span class="si">%s</span><span class="s">, &#39;</span>
                             <span class="s">&#39;Compute node -- </span><span class="si">%s</span><span class="s">, &#39;</span>
                             <span class="s">&#39;Instance type -- </span><span class="si">%s</span><span class="s">, &#39;</span>
                             <span class="s">&#39;Cluster size -- </span><span class="si">%s</span><span class="s">&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="s">&#39;control&#39;</span><span class="p">],</span> <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;compute&#39;</span><span class="p">],</span>
                                <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">],</span> <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cluster_size</span><span class="p">(</span>
                                                        <span class="n">cloud</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">node_type</span> <span class="o">=</span> <span class="s">&#39;control node&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">node_type</span> <span class="o">=</span> <span class="s">&#39;compute node&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s">&#39;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">node_type</span><span class="p">,</span>
                                    <span class="n">cloud</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">],</span> <span class="n">cloud</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s">&#39;image&#39;</span><span class="p">],</span>
                                    <span class="n">cloud</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">if_exist</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Error in finding virtual cluster </span><span class="si">%s</span><span class="s">, not created.&#39;</span>
                          <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cloud_instances_by_name</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">====================================&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Virtual Cluster </span><span class="si">%s</span><span class="s"> (status: </span><span class="si">%s</span><span class="s">)&#39;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_status</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;====================================&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">SAVED</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Control node -- </span><span class="si">%s</span><span class="s">, &#39;</span>
                         <span class="s">&#39;Compute node -- </span><span class="si">%s</span><span class="s">, &#39;</span>
                         <span class="s">&#39;Instance type -- </span><span class="si">%s</span><span class="s">, &#39;</span>
                         <span class="s">&#39;Cluster size -- </span><span class="si">%s</span><span class="s">&#39;</span>
                         <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;control&#39;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;compute&#39;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_list</span><span class="p">()[</span><span class="s">&#39;size&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cluster_size</span><span class="p">()):</span>
                    <span class="n">cloud</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">node_type</span> <span class="o">=</span> <span class="s">&#39;control node&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node_type</span> <span class="o">=</span> <span class="s">&#39;compute node&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s">&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">node_type</span><span class="p">,</span>
                                <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;ip&#39;</span><span class="p">],</span> <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">],</span>
                                <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]))</span>

<span class="c"># ---------------------------------------------------------------------</span>
<span class="c"># METHODS TO SHOW VIRTUAL CLUSTER LIST</span>
<span class="c"># ---------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="Cluster.get_list"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.Cluster.get_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        lists all virtual clusters and status</span>

<span class="sd">        Parameters:</span>
<span class="sd">            args -- this method deals with</span>
<span class="sd">                    None</span>

<span class="sd">        Logic:</span>
<span class="sd">            Reads from backup file to load all virtual cluster information</span>
<span class="sd">            If no cloud instance saved, after shows help message, then quits</span>
<span class="sd">            the program</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># get all cloud instances lists</span>
        <span class="n">cloud_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_all_cloud_instances</span><span class="p">()</span>
        <span class="c"># if no cloud created, then prints msg and quits</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cloud_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">You do not have any virtual clusters&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">===============================&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;Virtual Cluster list&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;================================&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cloud</span> <span class="ow">in</span> <span class="n">cloud_set</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s"> compute nodes, 1 control node; status: </span><span class="si">%s</span><span class="s">&#39;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">cloud</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cloud_instances</span><span class="o">.</span><span class="n">get_cluster_size</span><span class="p">(</span><span class="n">cloud</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">cloud</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]))</span>

<span class="c">######################################################################</span>
<span class="c"># MAIN</span>
<span class="c">######################################################################</span>

</div></div>
<div class="viewcode-block" id="commandline_parser"><a class="viewcode-back" href="../../../../modules.html#futuregrid.virtual.cluster.FGCluster.commandline_parser">[docs]</a><span class="k">def</span> <span class="nf">commandline_parser</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parses commandline</span>

<span class="sd">    Checks if python version is above 2.7</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># Check pyhon version</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;ERROR: you must use python 2.7 or greater&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">virtual_cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">()</span>

    <span class="n">parser</span> <span class="o">=</span> \
        <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;Virtual&#39;</span>
                                <span class="s">&#39; cluster management operations&#39;</span><span class="p">,</span>
                                <span class="n">version</span><span class="o">=</span><span class="s">&#39;0.2.0&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--file&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Specify futuregrid configure file&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;print debug message&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--default-repository&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;using default software repository&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--create-key&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;create userkey&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--interface&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;choose interface to use&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--cloud&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;choose cloud&#39;</span><span class="p">)</span>
    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s">&#39;commands&#39;</span><span class="p">)</span>

    <span class="c"># status command</span>
    <span class="n">status_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Show virtual cluster status&#39;</span><span class="p">)</span>
    <span class="n">status_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--name&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s">&#39;Show status of &#39;</span>
                               <span class="s">&#39;virtual cluster of given name&#39;</span><span class="p">)</span>
    <span class="n">status_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">virtual_cluster</span><span class="o">.</span><span class="n">show_status</span><span class="p">)</span>

    <span class="c"># list command</span>
    <span class="n">list_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;list&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;List virtual cluster and status&#39;</span><span class="p">)</span>
    <span class="n">list_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">virtual_cluster</span><span class="o">.</span><span class="n">get_list</span><span class="p">)</span>

    <span class="c"># run command</span>
    <span class="n">run_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;run&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Create a virtual cluster&#39;</span><span class="p">)</span>
    <span class="n">run_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--name&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                            <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Virtual cluster name&#39;</span><span class="p">)</span>
    <span class="n">run_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--number&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                            <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Numbe of compute nodes&#39;</span>
                            <span class="p">)</span>
    <span class="n">run_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--type&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                            <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Instance type&#39;</span><span class="p">)</span>
    <span class="n">run_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-i&#39;</span><span class="p">,</span> <span class="s">&#39;--image&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                            <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Image id&#39;</span><span class="p">)</span>
    <span class="n">run_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">virtual_cluster</span><span class="o">.</span><span class="n">create_cluster</span><span class="p">)</span>

    <span class="c"># terminate command</span>
    <span class="n">terminate_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;terminate&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Terminate virtual cluster&#39;</span><span class="p">)</span>
    <span class="n">terminate_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--name&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                  <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;Virtual cluster name&#39;</span><span class="p">)</span>
    <span class="n">terminate_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">virtual_cluster</span><span class="o">.</span><span class="n">shut_down</span><span class="p">)</span>

    <span class="c"># checkpoint command</span>
    <span class="n">checkpoint_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;checkpoint&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Save virtual cluster&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--name&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Virtual cluster name&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--controlb&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Control node bucket name&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--controln&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Control node image name&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--computeb&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Compute node bucket name&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-e&#39;</span><span class="p">,</span> <span class="s">&#39;--computen&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                   <span class="n">help</span><span class="o">=</span><span class="s">&#39;Compute node image name&#39;</span><span class="p">)</span>
    <span class="n">checkpoint_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">virtual_cluster</span><span class="o">.</span><span class="n">checkpoint_cluster</span><span class="p">)</span>

    <span class="c"># restore command</span>
    <span class="n">restore_parser</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">&#39;restore&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Restore saved virtual cluster&#39;</span><span class="p">)</span>
    <span class="n">restore_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-a&#39;</span><span class="p">,</span> <span class="s">&#39;--name&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                                <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&#39;Virtual cluster name&#39;</span><span class="p">)</span>
    <span class="n">restore_parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">virtual_cluster</span><span class="o">.</span><span class="n">restore_cluster</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c"># parse config file, if config file is not specified,</span>
    <span class="c"># then use default file which is ~/.futuregrid/futuregrid.cfg</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
        <span class="n">virtual_cluster</span><span class="o">.</span><span class="n">parse_conf</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">virtual_cluster</span><span class="o">.</span><span class="n">parse_conf</span><span class="p">()</span>

    <span class="c"># set flags</span>
    <span class="n">virtual_cluster</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="c"># choose interface</span>
    <span class="n">virtual_cluster</span><span class="o">.</span><span class="n">set_cloud</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span>
    <span class="n">virtual_cluster</span><span class="o">.</span><span class="n">set_interface</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">interface</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">commandline_parser</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Rain Home</a>|&nbsp;</li>
        <li><a href="../../../../whatis.html">What is FutureGrid Rain?</a>|&nbsp;</li>
        <li><a href="../../../../quickstart.html">Rain Quickstart</a>|&nbsp;</li>
        <li><a href="../../../../documentation.html">Rain Documentation </a>|&nbsp;</li>
        <li><a href="../../../../download.html">Download</a>|&nbsp;</li>
        <li><a href="../../../../support.html">Support</a>|&nbsp;</li>
        <li><a href="https://portal.futuregrid.org/">FutureGrid Home</a>|&nbsp;</li>

          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Gregor von Laszewski, Fugang Wang, Hyungro Lee, Javier Diaz.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>